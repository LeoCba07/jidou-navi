-- Fix Upvote XP Exploit
-- Deducts XP when an upvote is removed to prevent farming XP by toggling upvotes

CREATE OR REPLACE FUNCTION remove_upvote(p_machine_id UUID)
RETURNS JSON AS $$
DECLARE
    weekly_count INT;
    max_weekly_upvotes INT := 3;
    xp_per_upvote INT := 5;
BEGIN
    -- Check if user is authenticated
    IF auth.uid() IS NULL THEN
        RETURN json_build_object('success', false, 'error', 'not_authenticated');
    END IF;

    -- Check if upvote exists
    IF NOT EXISTS (
        SELECT 1 FROM machine_upvotes
        WHERE user_id = auth.uid() AND machine_id = p_machine_id
    ) THEN
        RETURN json_build_object('success', false, 'error', 'not_upvoted');
    END IF;

    -- Remove upvote
    DELETE FROM machine_upvotes
    WHERE user_id = auth.uid() AND machine_id = p_machine_id;

    -- Deduct XP (prevent exploit)
    -- Ensure XP doesn't go below 0
    UPDATE profiles
    SET xp = GREATEST(0, COALESCE(xp, 0) - xp_per_upvote)
    WHERE id = auth.uid();

    -- Get remaining weekly count
    SELECT COUNT(*)::INT INTO weekly_count
    FROM machine_upvotes
    WHERE user_id = auth.uid()
      AND created_at >= date_trunc('week', NOW());

    RETURN json_build_object(
        'success', true,
        'remaining_votes', max_weekly_upvotes - weekly_count
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
